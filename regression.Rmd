---
title: "Regression"
output: html_document

---

```{r}
library(tidyverse)
library(modelr)
library(mgcv)
library(MPV)
library(leaps)
library(p8105.datasets)
library(MASS)
library(ggplot2)
library(car)
```





# import data
```{r}
overall_dataset = read.csv("data/overall_dataset.csv")
```


```{r}
NA_table_1 = 
  overall_dataset|> 
  is.na()|> 
  colSums()
NA_table_1|> 
    knitr::kable(col.names = c("Counts of NA"))
```

```{r}
overall_dataset =
  overall_dataset|>
  drop_na()|>
  dplyr::select(-country_name, -latitude, -longitude)
```


# Full model
```{r}
full.model = lm(corruption_index ~ ., data = overall_dataset)
empty.model = lm(corruption_index ~ 1,data = overall_dataset)
```


The full model includes all variables except latitude and longitude since continent is included as location information. This model is treated as the baseline to compare with model after selection. 

## summary of full model



Tables below show summary information of the full model. The p-value for government_effectiveness, rule_of_law, voice_and_accountability, continentEurope 
have p-value lower than any reasonable significance level(1%, 5%, 10%), which means these variable are more significant than other in this model. The R2adj for this model is 0.8983053, which presents a very high proportion of variance in response variable explained the linear relationship between with predictors and response variable.


```{r}
All.Criteria = function(the.model){
  tibble(
   
    the.BIC = BIC(the.model),
    the.LL = logLik(the.model),
    the.AIC = AIC(the.model),
    the.PRESS = PRESS(the.model),
    the.R2adj = summary(the.model)$adj.r.squared,
   
    
  )
}
full.model|>
  broom::tidy()|>
  dplyr::select(term, estimate, p.value)|>
  knitr::kable(caption ="Estimate and P-value for full model")
  
All.Criteria(full.model)|>
  knitr::kable(caption = "Criterias for full model")
```




## check normality and remove outlier



Plots below shows that the residuals are overall normally distributed. The qq-plot shows the regression is linear and there is no need to add transformation variables. Then, outliers are detected and removed by using cutoffs based on t distribution. With data after removing oultiers, the full model is updated, and BIC and AIC are all decreased.

```{r}
SR = stdres(full.model)
n = length(full.model$residuals) 
p = length(full.model$coefficients)
alpha = 0.01 
t.cutoff = qt(1- alpha/2, n-p)

par(mfrow=c(2,2))
plot(full.model)

outliers = which(abs(SR)>t.cutoff)
outliers|>
  knitr::kable(caption = "outliers")
new.data = overall_dataset[-outliers,]

full.model = lm(corruption_index ~ ., data = new.data)
All.Criteria(full.model)|>
  knitr::kable(caption ="Estimate and P-value for updated full model")
  
```

# Selected model



After the updated full model is built, backward and forward selection function is applied to gain selected  models.



## backward model selection



The summary of backward selected model is shown below. political_stability_and_absence_of_violence_terrorism, regulatory_quality, GDP are deleted.


```{r}
backward.model.AIC = stepAIC(full.model, scope = list(lower = empty.model, upper= full.model), k = 2,direction = "backward",trace = FALSE)
forward.model.AIC = stepAIC(empty.model, scope = list(lower = empty.model, upper= full.model), k = 2,direction = "forward",trace = FALSE)
```

```{r}
backward.model.AIC|>
  broom::tidy()|>
  dplyr::select(term, estimate, p.value)|>
  knitr::kable(caption ="Estimate and P-value for backward selected model")

All.Criteria(backward.model.AIC)|>
  knitr::kable(caption = "Criterias for backward selected selected model")
```


## forward model selection 



The summary of forward selected model is shown below. political_stability_and_absence_of_violence_terrorism, regulatory_quality, GDP, continent are deleted.

```{r}
forward.model.AIC|>
  broom::tidy()|>
  dplyr::select(term, estimate, p.value)|>
  knitr::kable(caption ="Estimate and P-value for forward selected model")

All.Criteria(forward.model.AIC)|>
  knitr::kable(caption = "Criterias for forward selected selected model")
```


## Comparision of full model, forward and backward selected model

Backward selected model has the lowest BIC and highest R2adj. We would say that the 
backward selected model is the most optiaml model among these three.
 
```{r}
forward_model = All.Criteria(forward.model.AIC)|>
  mutate(the.LL = as.double(the.LL))
backward_model = All.Criteria(backward.model.AIC)|>
  mutate(the.LL = as.double(the.LL))

full_model = All.Criteria(full.model)|>
  mutate(the.LL = as.double(the.LL))

comparsion = 
  bind_rows( full_model,forward_model, backward_model)|>
  mutate(model = c('full', 'forward', 'backward'))|>
  dplyr::select(model, everything())|>
  knitr::kable(caption = "Comparision of full model, forward and backward selected model")
  
  
comparsion


  


```


## cross validation 


```{r}
cv_df =
  crossv_mc(new.data, 100) |> 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))
```

```{r}
cv_df = 
  cv_df |> 
  mutate(
    model_full  = map(train, \(df) lm(corruption_index ~ ., data = df)),
    model_forward  = map(train, \(df) lm(corruption_index ~ rule_of_law + government_effectiveness + voice_and_accountability + development, data = df)),
    model_backward  = map(train, \(df) lm(corruption_index ~ rule_of_law + government_effectiveness + voice_and_accountability + development+ continent, data = df)))|> 
  mutate(
    rmse_full = map2_dbl(model_full, test, \(mod, df) rmse(model = mod, data = df)),
    rmse_forward = map2_dbl(model_forward, test, \(mod, df) rmse(model = mod, data = df)),
    rmse_backward = map2_dbl(model_backward, test, \(mod, df) rmse(model = mod, data = df)))
```


```{r}
cv_df |> 
  dplyr::select(starts_with("rmse")) |> 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") |> 
  mutate(model = fct_inorder(model)) |> 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```

